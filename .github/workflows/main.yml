name: Build ISO and update latest release

permissions:
  contents: write

on:
  push:   # every push

jobs:
  build-iso:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive   # fetch and init all submodules
          fetch-depth: 0          # full history (needed if submodules use tags)

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y gcc make grub-common xorriso mtools cpio gzip

      - name: Build ISO
        run: make clean && make iso

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Upload atlaslinux-x86_64.iso to 'latest' release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create or update the 'latest' release
          gh release view latest || gh release create latest --title "Latest" --notes "Automated build"
          # If the asset already exists, delete it before uploading
          if gh release view latest --json assets --jq '.assets[].name' | grep -q '^atlaslinux-x86_64.iso$'; then
            gh release delete-asset latest atlaslinux-x86_64.iso -y
          fi
          # Upload new iso
          gh release upload latest atlaslinux-x86_64.iso --clobber
